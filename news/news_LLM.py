import os
import google.generativeai as genai
import requests
from bs4 import BeautifulSoup
from newspaper import Article
from dotenv import load_dotenv

load_dotenv()
api_key = os.getenv("GOOGLE_API_KEY")
if not api_key:
    raise ValueError(".envì—ì„œ GOOGLE_API_KEYë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
genai.configure(api_key=api_key)

model = genai.GenerativeModel("gemini-2.5-flash")


def extract_title_and_body(url):
    article = Article(url, language='ko')
    article.download()
    article.parse()
    title = article.title.strip()
    body = article.text.strip()
    if len(body) < 50:
        print("ğŸ“Œ ë³¸ë¬¸ì´ ì§§ì•„ fallbackìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.")
        title, body = extract_naver_cp_article(url)
    return title, body

def extract_naver_cp_article(url):
    headers = {'User-Agent': 'Mozilla/5.0'}
    res = requests.get(url, headers=headers)
    soup = BeautifulSoup(res.text, 'html.parser')
    title_tag = soup.select_one('h2.media_end_head_headline')
    title = title_tag.text.strip() if title_tag else "ì œëª© ì—†ìŒ"
    body_area = soup.select_one('article#dic_area')
    body = body_area.get_text(separator="\n").strip() if body_area else "ë³¸ë¬¸ ì—†ìŒ"
    return title, body

def generate_system_prompt(keyword: str) -> str:
    return f"""
            [ì‹œìŠ¤í…œ ë©”ì„¸ì§€]
            ë‹¨ê³„ë³„ë¡œ ê¸°ì‚¬ë¥¼ ì‘ì„±í•˜ê³ , **ì¶œë ¥ê·œì¹™ì— ë§ê²Œ ì œëª©ê³¼ ë³¸ë¬¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”.**
            â€» ì „ì²´ ê¸°ì‚¬ ì œëª©ê³¼ ë³¸ë¬¸ ë‹¤ìŒ í‘œí˜„ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤: ë³¼ë“œì²´(**), ë§ì¤„ì„í‘œ(...), ë§ˆì¹¨í‘œ(.), ìŒë”°ì˜´í‘œ(" "), ì½œë¡ (:), ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(*, #, &), ê°íƒ„ë¬¸, ì§ˆë¬¸í˜• ë¬¸ì¥, ê¸°ì ë©”ì¼ ì£¼ì†Œ ë° ê¸°ìëª… í‘œê¸°

            1. ë³¸ë¬¸ ìƒì„±: ì…ë ¥ëœ ê¸°ì‚¬ ë³¸ë¬¸ ë‚´ìš©ë§Œ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ê¸°ì‚¬ ë³¸ë¬¸ì„ ì‘ì„±í•œë‹¤.
            - 500~1500ì ë‚´ì™¸ë¡œ ì‘ì„± (ë‹¨, ì œê³µëœ ê¸°ì‚¬ê°€ ì§§ìœ¼ë©´ ë¶ˆí•„ìš”í•œ ë‚´ìš©ì„ ì¶”ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.)
            - ê¸°ì‚¬ì˜ íë¦„ê³¼ ë…¼ì ì„ ìœ ì§€í•˜ë˜, ë¬¸ì¥ì´ ì–´ìƒ‰í•˜ê±°ë‚˜ ë‹¨ì ˆë  ê²½ìš° ë¬¸ë§¥ì— ë§ê²Œ ì¬êµ¬ì„±í•  ìˆ˜ ìˆë‹¤. ì´ë•Œ ì˜ë¯¸ë¥¼ ì™œê³¡í•˜ê±°ë‚˜ ë‚´ìš©ì„ ê³¼ì¥Â·ì¶”ê°€í•´ì„œëŠ” ì•ˆ ëœë‹¤.
            - íŠ¹íˆ ì²« ë²ˆì§¸ ë¬¸ì¥ì€ ì›ë¬¸ê³¼ êµ¬ë¶„ë˜ëŠ” ìƒˆë¡œìš´ ìš”ì•½í˜• ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ì œê³µëœ ê¸°ì‚¬ì—ì„œ ëª…ì‹œëœ ì‚¬ì‹¤ ì¤‘ í•µì‹¬ ì¸ë¬¼Â·ì¡°ì¹˜Â·ë°°ê²½ ì •ë³´ë¥¼ í¬í•¨í•œ ìš”ì•½ ë¬¸ì¥ìœ¼ë¡œ êµ¬ì„±í•œë‹¤. (ë‹¨, ê¸°ì‚¬ ì™¸ ì •ë³´ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì˜ë¯¸ë¥¼ ì¶”ì¸¡Â·ì™œê³¡í•˜ì§€ ì•ŠëŠ”ë‹¤.)
            - ì£¼ìš” íë¦„ê³¼ ë…¼ë€ì˜ ìŸì ì„ ì™œê³¡í•˜ì§€ ì•ŠëŠ”ë‹¤.
            - **ì¸ìš©ë¬¸ì€ ë‹¨ì–´ í•˜ë‚˜ë„ ë³€ê²½í•˜ì§€ ì•ŠëŠ”ë‹¤.**
            - ì¸ìš©ë¬¸ì„ ì œì™¸í•œ ëª¨ë“  ë¬¸ì¥ì—ì„œ **ê²©ì‹ì²´ ì¢…ê²°ì–´ë¯¸(ìŠµë‹ˆë‹¤, í•©ë‹ˆë‹¤, ì…ë‹ˆë‹¤ ë“±)**ë¥¼ **ë°˜ë“œì‹œ í‰ì„œí˜•(í–ˆë‹¤, í•œë‹¤, ì´ë‹¤ ë“±)**ìœ¼ë¡œ ì‘ì„±í•œë‹¤.
            - ê²©ì‹ì²´ í‘œí˜„ì´ ë‚¨ì•„ ìˆì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ê³ , ë§ì¶¤ë²•ì— ë§ê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ë°”ê¾¸ì–´ì•¼ í•˜ë©°, ì¶œë ¥ ì „ ë°˜ë“œì‹œ ê²€ìˆ˜í•œë‹¤.
            - ë‹¤ìŒì€ ìì£¼ ì‚¬ìš©ë˜ëŠ” ì˜ˆì‹œì´ë©°, ë¬¸ë§¥ì— ë”°ë¼ ì ìš©í•´ì•¼ í•œë‹¤:
                - "ì…ë‹ˆë‹¤" â†’  "ì´ë‹¤" ë˜ëŠ” "ë‹¤" 
                - "í–ˆìŠµë‹ˆë‹¤" â†’ "í–ˆë‹¤"
                - "í•©ë‹ˆë‹¤" â†’ "í•œë‹¤"
                - "ì—†ìŠµë‹ˆë‹¤" â†’ "ì—†ë‹¤"
                - "ë˜ì—ˆë‹¤" ë° "ë˜ì—ˆìŠµë‹ˆë‹¤"â†’ "ëë‹¤"
            - ëª¨ë“  ë¬¸ì¥ì€ êµ­ë¦½êµ­ì–´ì› ë§ì¶¤ë²• ê¸°ì¤€ì„ ì¤€ìˆ˜í•´ì•¼ í•˜ë©°, ë„ì–´ì“°ê¸°ë‚˜ ì–´ìƒ‰í•œ í‘œí˜„ì´ ì—†ë„ë¡ ì£¼ì˜í•œë‹¤.
            - **ë³¼ë“œì²´(êµµì€ ê¸€ì”¨,**) ì‚¬ìš© ê¸ˆì§€.**  
            - ë³¸ë¬¸ì€ ë°˜ë“œì‹œ ì„¸ ë¬¸ì¥ë§ˆë‹¤ ì¤„ë°”ê¿ˆí•œë‹¤. (**ì…ë ¥ ë‚´ìš©ì´ ì§§ì•„ë„ ì´ ê·œì¹™ì€ ë™ì¼í•˜ê²Œ ì ìš©í•˜ë©°, ì¤„ë°”ê¿ˆì€ ì‹œê°ì  êµ¬ë¶„ì„ ìœ„í•œ ê²ƒì´ë‹¤.**)

            2. ì œëª© ìƒì„±
            - ì‘ì„±ëœ ë³¸ë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ ì œëª©ì„ ì°½ì˜ì ìœ¼ë¡œ ì‘ì„±í•œë‹¤.
            - ì œê³µëœ ê¸°ì‚¬ ì œëª©ì˜ í•µì‹¬ ë‚´ìš©ì„ ì°¸ê³ í•˜ë˜, ë³¸ë¬¸ì—ì„œ ë“œëŸ¬ë‚œ í•µì‹¬ ì£¼ì œë¥¼ ìš°ì„  ë°˜ì˜í•œë‹¤.
            - ì…ë ¥ëœ í‚¤ì›Œë“œë¥¼ ìµœëŒ€í•œ ì•ìª½ì— ë°°ì¹˜í•˜ê³ , ê´€ë ¨ì„±ì´ ì ì–´ë„ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨ë˜ë„ë¡ ì‘ì„±í•œë‹¤.
            - ì œê³µëœ ì œëª©ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ê¸ˆì§€í•œë‹¤.
            - ê¶ê¸ˆì¦ì„ ìœ ë°œí•˜ëŠ” í‘œí˜„ ê¸ˆì§€ (ì˜ˆ: '?', 'ì™œ', 'ì–´ë–»ê²Œ', 'ë¬´ì—‡ì´' ë“± ì‚¬ìš© ê¸ˆì§€)
            - ë¶€ì •ì ì¸ í‘œí˜„ì„ ê¸ì •ì ì¸ ë°©í–¥ìœ¼ë¡œ ì¡°ì •í•œë‹¤.

            3. ì œëª© ë° ë³¸ë¬¸ ê²€í†  
            - ë§ì¶¤ë²• ë° ë„ì–´ì“°ê¸° ì¤€ìˆ˜ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³ , ë¬¸ì¥ì´ ìì—°ìŠ¤ëŸ½ë„ë¡ ìˆ˜ì •
            - ì œëª©ê³¼ ë³¸ë¬¸ì—ì„œ ê¸ˆì§€ëœ í‘œí˜„(ë³¼ë“œì²´(**, êµµì€ê¸€ì”¨), ë§ì¤„ì„í‘œ(...), ë§ˆì¹¨í‘œ(.), ìŒë”°ì˜´í‘œ(" "), ì½œë¡ (:), ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(*, #, &), ê°íƒ„ë¬¸, ì§ˆë¬¸í˜• ë¬¸ì¥, ê¸°ì ë©”ì¼ ì£¼ì†Œ ë° ê¸°ìëª… í‘œê¸°) ì‚¬ìš© ì—¬ë¶€ í™•ì¸ ë° ìˆ˜ì •
            - ì œê³µëœ ì •ë³´ ì™¸ ì¶”ì¸¡Â·í—ˆêµ¬Â·ì™¸ë¶€ ìë£Œ ì¶”ê°€ ì—¬ë¶€ ê²€í†  í›„ ìˆ˜ì •
            - **ì¸ìš©ë¬¸ ì™¸ì—ì„œ ê²©ì‹ì²´ ì¢…ê²°ì–´ë¯¸ ì‚¬ìš©ì—¬ë¶€ í™•ì¸ í›„,  í‰ì„œí˜• ì¢…ê²°ì–´ë¯¸ë¡œ ë³€ê²½í•œë‹¤.**  (ì˜ˆ: "ì…ë‹ˆë‹¤" â†’ "ì´ë‹¤" or "ë‹¤", "í–ˆìŠµë‹ˆë‹¤" â†’ "í–ˆë‹¤", "í•©ë‹ˆë‹¤" â†’ "í•œë‹¤", "ë˜ì—ˆë‹¤" ë° "ë˜ì—ˆìŠµë‹ˆë‹¤"â†’ "ëë‹¤")

            4. ì¶œë ¥ê·œì¹™
            - ì œëª©ê³¼ ë³¸ë¬¸ì„ ì¶œë ¥í•˜ì„¸ìš”.  
            - ìƒì„±ëœ í…ìŠ¤íŠ¸ ì™¸ ë‹¤ë¥¸ ë¬¸ì¥ì€ ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤  
            - ì²« ì¤„: ì œëª©  
            - ë‘ ë²ˆì§¸ ì¤„ë¶€í„°: ë³¸ë¬¸
            - ì €í¬ëŠ” ì²« ì¤„ì„ ì œëª©ìœ¼ë¡œ ì¸ì‹í•˜ê³ , ë‘ ë²ˆì§¸ ì¤„ë¶€í„° ë³¸ë¬¸ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.
"""


def generate_article(state: dict) -> dict:
    url = state.get("url")
    keyword = state.get("keyword")

    try:
        title, body = extract_title_and_body(url)
        system_prompt = generate_system_prompt(keyword)
        user_request = f"í‚¤ì›Œë“œ: {keyword}\nì œëª©: {title}\në³¸ë¬¸: {body}"

        contents = [
            {'role': 'user', 'parts': [{'text': system_prompt}]},
            {'role': 'model', 'parts': [{'text': 'ì´í•´í–ˆìŠµë‹ˆë‹¤. ê·œì¹™ì„ ë”°ë¥´ê² ìŠµë‹ˆë‹¤.'}]},
            {'role': 'user', 'parts': [{'text': user_request}]}
        ]


        response = model.generate_content(contents)
        article_text = response.text.strip()

        return {
            "url": url,
            "keyword": keyword,
            "title": title,
            "original_body": body,
            "generated_article": article_text,
            "error": None
        }
    except Exception as e:
        return {
            "url": url,
            "keyword": keyword,
            "title": "",
            "original_body": "",
            "generated_article": "",
            "error": str(e)
        }

if __name__ == "__main__":
    print("ğŸ”— ê¸°ì‚¬ URLê³¼ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ë©´ Geminiê°€ ì¬ì‘ì„±í•œ ê¸°ì‚¬ë¡œ ë³€í™˜í•´ì¤ë‹ˆë‹¤.")
    url = input("ê¸°ì‚¬ URLì„ ì…ë ¥í•˜ì„¸ìš”: ").strip()
    keyword = input("í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”: ").strip()

    result = generate_article({"url": url, "keyword": keyword})

    if result["error"]:
        print("âŒ ì˜¤ë¥˜ ë°œìƒ:", result["error"])
    else:
        print("\nâœ… ê¸°ì‚¬ ì¬ì‘ì„± ì™„ë£Œ:")
        print("\nğŸ“Œ ì›ì œëª©:", result["title"])
        print("\nğŸ“ ì¬ì‘ì„± ê¸°ì‚¬:\n")
        print(result["generated_article"])
